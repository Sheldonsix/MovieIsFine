# ç”µå½±æ•°æ®æ›´æ–°è„šæœ¬

æœ¬ç›®å½•åŒ…å«ç”¨äºå®šæœŸæ›´æ–°ç”µå½±æ•°æ®çš„è„šæœ¬å’Œé…ç½®æ–‡ä»¶ã€‚

## ğŸ“ æ–‡ä»¶ç»“æ„

```
scripts/
â”œâ”€â”€ update-movie-data.ts          # ä¸»æ›´æ–°è„šæœ¬
â”œâ”€â”€ test-update.ts                # æµ‹è¯•è„šæœ¬
â””â”€â”€ cron/                         # å®šæ—¶ä»»åŠ¡ç›¸å…³
    â”œâ”€â”€ run-at-random-time.sh     # Bash éšæœºæ—¶é—´è°ƒåº¦å™¨
    â””â”€â”€ scheduler.ts              # Node.js è°ƒåº¦å™¨

docs/
â””â”€â”€ scheduled-update-guide.md     # è¯¦ç»†çš„é…ç½®æŒ‡å—

logs/
â””â”€â”€ *.log                         # æ—¥å¿—æ–‡ä»¶ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æµ‹è¯•è„šæœ¬

åœ¨é¦–æ¬¡ä½¿ç”¨å‰ï¼Œå»ºè®®å…ˆæµ‹è¯•è„šæœ¬æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š

```bash
# æµ‹è¯•æ›´æ–° 5 éƒ¨ç”µå½±ï¼ˆDRY RUN æ¨¡å¼ï¼Œä¸ä¼šå®é™…ä¿®æ”¹æ•°æ®åº“ï¼‰
npx tsx scripts/test-update.ts

# æˆ–æ‰‹åŠ¨æµ‹è¯•
npx tsx scripts/update-movie-data.ts --limit 5 --dry-run
```

### 2. æ‰‹åŠ¨æ‰§è¡Œæ›´æ–°

```bash
# æ›´æ–° 250 éƒ¨ç”µå½±ï¼ˆé»˜è®¤ï¼‰
npx tsx scripts/update-movie-data.ts

# æ›´æ–°æŒ‡å®šæ•°é‡
npx tsx scripts/update-movie-data.ts --limit 100

# æ›´æ–°å•éƒ¨ç”µå½±
npx tsx scripts/update-movie-data.ts --douban-id 1292052
```

### 3. è®¾ç½®å®šæ—¶ä»»åŠ¡

è¯¦ç»†é…ç½®è¯·å‚è€ƒ [å®šæ—¶ä»»åŠ¡é…ç½®æŒ‡å—](../docs/scheduled-update-guide.md)

#### æ–¹æ¡ˆ Aï¼šä½¿ç”¨ Cronï¼ˆæ¨èï¼‰

```bash
# ç¼–è¾‘ crontab
crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ¯å¤© 10:00 å¯åŠ¨éšæœºå»¶è¿Ÿè°ƒåº¦å™¨ï¼‰
0 10 * * * /home/sheldon/my-code/MovieIsFine/scripts/cron/run-at-random-time.sh
```

#### æ–¹æ¡ˆ Bï¼šä½¿ç”¨ Node.js è°ƒåº¦å™¨ + PM2

```bash
# å®‰è£… PM2ï¼ˆå¦‚æœè¿˜æ²¡å®‰è£…ï¼‰
npm install -g pm2

# å¯åŠ¨è°ƒåº¦å™¨
pm2 start scripts/cron/scheduler.ts --name movie-scheduler

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save

# æŸ¥çœ‹çŠ¶æ€
pm2 status
pm2 logs movie-scheduler
```

## ğŸ“Š åŠŸèƒ½ç‰¹æ€§

### æ™ºèƒ½é€‰æ‹©ç­–ç•¥
- **70%** æ¥è‡ªæ›´æ–°æ—¶é—´æœ€æ—©çš„ç”µå½±ï¼ˆç¡®ä¿æ—§æ•°æ®å¾—åˆ°æ›´æ–°ï¼‰
- **30%** å®Œå…¨éšæœºé€‰æ‹©ï¼ˆä¿æŒæ•°æ®å¤šæ ·æ€§ï¼‰

### å¢é‡æ›´æ–°
- è‡ªåŠ¨æ¯”è¾ƒæ–°æ—§æ•°æ®
- ä»…æ›´æ–°æœ‰å˜åŒ–çš„å­—æ®µ
- èŠ‚çœæ•°æ®åº“å†™å…¥å’Œç½‘ç»œå¸¦å®½

### é˜²çˆ¬ä¿æŠ¤
- è¯·æ±‚é—´éš” 3-5 ç§’ï¼ˆå¸¦éšæœºå»¶è¿Ÿï¼‰
- é¿å…è§¦å‘è±†ç“£åçˆ¬è™«æœºåˆ¶

### è¯¦ç»†æ—¥å¿—
- è®°å½•æ¯æ¬¡æ›´æ–°çš„è¯¦ç»†ä¿¡æ¯
- åŒ…å«æˆåŠŸ/å¤±è´¥/è·³è¿‡çš„ç»Ÿè®¡
- ä¾¿äºæ’æŸ¥é—®é¢˜

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šæµ‹è¯•å•éƒ¨ç”µå½±æ›´æ–°

```bash
npx tsx scripts/update-movie-data.ts --douban-id 1292052 --dry-run
```

è¾“å‡ºï¼š
```
[1/1] è‚–ç”³å…‹çš„æ•‘èµ (è±†ç“£ID: 1292052)
  ä¸Šæ¬¡æ›´æ–°: 2025-12-15
  âœ“ æ£€æµ‹åˆ° 2 ä¸ªå­—æ®µå˜åŒ–: doubanRating, ratingCount
  [DRY RUN] å°†æ›´æ–°ä»¥ä¸‹å­—æ®µ:
    - doubanRating: 9.7
    - ratingCount: 2500000
```

### ç¤ºä¾‹ 2ï¼šæ‰¹é‡æ›´æ–°

```bash
npx tsx scripts/update-movie-data.ts --limit 100
```

### ç¤ºä¾‹ 3ï¼šæŸ¥çœ‹æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f logs/update-movie-data.log

# æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯
grep "âœ—" logs/update-movie-data.log

# æŸ¥çœ‹æ›´æ–°ç»Ÿè®¡
grep "å·²æ›´æ–°:" logs/update-movie-data.log
```

## ğŸ”§ é…ç½®é€‰é¡¹

### å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--limit N` | æ›´æ–°ç”µå½±æ•°é‡ | 250 |
| `--dry-run` | æµ‹è¯•æ¨¡å¼ï¼ˆä¸å®é™…æ›´æ–°ï¼‰ | false |
| `--douban-id ID` | æ›´æ–°æŒ‡å®šç”µå½± | - |

### ç¯å¢ƒå˜é‡

åœ¨ `.env.local` ä¸­é…ç½®ï¼š

```env
MONGODB_URI=mongodb://...
MONGODB_DB_NAME=movieisfine
```

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

- **å•éƒ¨ç”µå½±å¤„ç†æ—¶é—´**: 3-5 ç§’
- **250 éƒ¨ç”µå½±æ€»è€—æ—¶**: çº¦ 15-25 åˆ†é’Ÿ
- **æ•°æ®åº“æ“ä½œ**: <1 ç§’/éƒ¨
- **æˆåŠŸç‡**: >95%ï¼ˆå–å†³äºç½‘ç»œçŠ¶å†µï¼‰

## ğŸ›¡ï¸ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **è¿æ¥è¶…æ—¶**
   ```bash
   # æ£€æŸ¥ç½‘ç»œè¿æ¥
   ping movie.douban.com

   # æ£€æŸ¥ MongoDB è¿æ¥
   npx tsx scripts/migration/test-mongodb.ts
   ```

2. **æƒé™é”™è¯¯**
   ```bash
   chmod +x scripts/update-movie-data.ts
   chmod +x scripts/cron/run-at-random-time.sh
   ```

3. **ç¯å¢ƒå˜é‡æœªåŠ è½½**
   - ç¡®ä¿ `.env.local` æ–‡ä»¶å­˜åœ¨
   - æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®

### æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
cat logs/update-movie-data.log

# åªçœ‹å¤±è´¥çš„
grep "âœ— Failed" logs/update-movie-data.log

# æŸ¥çœ‹ç»Ÿè®¡æ‘˜è¦
grep -A 5 "æ›´æ–°æ‘˜è¦" logs/update-movie-data.log
```

## ğŸ“š æ›´å¤šèµ„æº

- [å®Œæ•´é…ç½®æŒ‡å—](../docs/scheduled-update-guide.md)
- [è±†ç“£çˆ¬è™«æœåŠ¡](../src/services/doubanScraper.ts)
- [ç”µå½±æ•°æ®æ¨¡å‹](../src/types/movie.ts)

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡è¿è¡ŒåŠ¡å¿…ä½¿ç”¨ `--dry-run` æ¨¡å¼æµ‹è¯•**
2. **å®šæœŸæ£€æŸ¥æ—¥å¿—ï¼Œå…³æ³¨å¤±è´¥ç‡**
3. **é¿å…åœ¨é«˜å³°æ—¶æ®µè¿è¡Œï¼ˆå»ºè®® 10:00-22:00ï¼‰**
4. **æ¯å¤©æ›´æ–° 100-300 éƒ¨ç”µå½±ä¸ºå®œ**
5. **å®šæœŸå¤‡ä»½æ•°æ®åº“**

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“„ è®¸å¯è¯

MIT
